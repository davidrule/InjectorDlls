name: Build LookBlockNet (x86)

on:
  push:
    branches: [ main, master ]
    paths:
      - 'LookBlockNet/**'
      - '.github/workflows/build-lookblocknet-x86.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSVC (x86)
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x86

      - name: Ensure Detours 4.0.1 (download)
        shell: cmd
        run: |
          if exist third_party\detours goto HAVE_DETOURS
          mkdir third_party
          cd third_party
          powershell -Command "Invoke-WebRequest -Uri https://github.com/microsoft/Detours/archive/refs/tags/v4.0.1.zip -OutFile detours.zip"
          powershell -Command "Expand-Archive detours.zip -DestinationPath ."
          ren Detours-4.0.1 detours
          del detours.zip
          :HAVE_DETOURS

      - name: Build Detours (x86)
        shell: cmd
        working-directory: ${{ github.workspace }}\third_party\detours\src
        run: |
          nmake clean || ver >nul
          nmake

      - name: Build version.dll proxy (x86)
        shell: cmd
        working-directory: ${{ github.workspace }}\LookBlockNet\version
        run: |
          set CL=/nologo /O2 /MT /DNOMINMAX /DWIN32_LEAN_AND_MEAN
          set INCLUDES=/I %GITHUB_WORKSPACE%\third_party\detours\include
          set LIBS=/link /nologo /dll /def:exports.def /out:version.dll kernel32.lib user32.lib shlwapi.lib %GITHUB_WORKSPACE%\third_party\detours\lib.X86\detours.lib /NOIMPLIB
          cl version.cpp %INCLUDES% %LIBS%

      - name: Build lookblocknet.dll (x86)
        shell: cmd
        working-directory: ${{ github.workspace }}\LookBlockNet\lookblocknet
        run: |
          set CL=/nologo /O2 /MT /DNOMINMAX /DWIN32_LEAN_AND_MEAN
          set INCLUDES=/I %GITHUB_WORKSPACE%\third_party\detours\include
          set LIBS=/link /nologo /out:lookblocknet.dll kernel32.lib user32.lib shlwapi.lib ws2_32.lib dnsapi.lib %GITHUB_WORKSPACE%\third_party\detours\lib.X86\detours.lib
          cl /LD lookblocknet.cpp %INCLUDES% %LIBS%

      - name: Upload artifacts (x86)
        uses: actions/upload-artifact@v4
        with:
          name: LookBlockNet-x86
          path: |
            ${{ github.workspace }}\LookBlockNet\version\version.dll
            ${{ github.workspace }}\LookBlockNet\lookblocknet\lookblocknet.dll

